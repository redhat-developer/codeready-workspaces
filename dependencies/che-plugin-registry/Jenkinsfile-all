#!/usr/bin/env groovy

// build params
//extensions - comma separated list of extensions

node {
    cleanWs()
    stage 'build extensions'
    def extensions = "${extensions}"

    // key value map for
    def jobs = [:]

    extensions.split(",").each { extension ->
        def keyValue = extension.split("\\|")
        echo "${keyValue}, ${extension}"

        def registryLocation = keyValue[0].split("//")[1]
        def extensionPath = keyValue[1]
        def branch = keyValue[2]

        echo "${registryLocation}, ${extensionPath}"

        def buildjob = build job: 'vscode-extensions-packaging', parameters: [ string(name: 'extensionPath', value: extensionPath), string(name: 'branchToBuildPlugin', value: branch) ]
        jobs.put(registryLocation, buildjob)
    }

    jobs.each { fileLocation, job ->
        echo "archiving artifact at ${fileLocation}"
        copyArtifacts(projectName: 'vscode-extensions-packaging', selector: specific("${job.number}"), target: fileLocation)
    }

    sh "ls -l"
    sh "tar -cvf vscode-extensions-vsix.tar ."


    // TODO deploy artifact to pkgs.devel?

    archiveArtifacts artifacts: '*.tar', fingerprint: true
}
